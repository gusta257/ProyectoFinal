<!-- Universidad del Valle de Guatemala -->
<!-- Alberto Andres Urizar Mancia   #17632 -->
<!-- Gustavo Adolfo de LeÃ³n Tobias  #17085 -->
<!-- Miniproyecto 5 -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miniproyecto 5</title>
</head>
<body>
    <!-- D = 2012, y = 1000/403 x - 3992.55 -->
    <canvas id="board" width="1800" height="900"></canvas>
    <!-- Logica de fuzzy -->
    <script>
        board = document.getElementById('board');
        ctx = board.getContext('2d',{alpha: false});
        // Posiciones iniciales
        
        let game_width = 800
        let game_height = 600
        let white = (255,255,255)
        let black = (0,0,0)
        let red = (255,0,0)
        let green = (0,255,0)
        let blue = (0,0,255)
        let fps = 60
        let size = 5
        let mutation_rate = 0.2
        let steering_weights = 0.5
        let perception_radius_mutation_range = 30
        let reproduction_rate = 0.0005
        let initial_perception_radius = 100
        let boundary_size = 10
        let max_vel = 10
        let initial_max_force = 0.5
        let health = 100
        let max_poison = 50
        let nutrition = [20, -80]
        let bots = []
        let food = []
        let poison = []
        let oldest_ever = 0
        let oldest_ever_dna = []


        function lerp(){
            percent_health = bot.health/health
            lerped_colour = (Math.max(Math.min((1-percent_health)*255,255),0), Math.max(Math.min(percent_health*255,255),0), 0)
            return(lerped_colour)
        }

        function magnitude_calc(vector){
            x = 0
            for(i = 0; i<= vector.length(); i++;){
                x += i**2
            }
            magnitude = x**0.5
            return(magnitude)
        }
        function normalize(vector){
            magnitude = magnitude_calc(vector)
            if(magnitude != 0){
                vector = vector/magnitude
            }
            return(vector)
        }
        class create_bot{
            constructor(x, y, dna=False) {
                this.position = [x,y]
                this.velocity = [((Math.random() * max_vel) * (Math.round(Math.random()) ? 1 : -1)),((Math.random() * max_vel) * (Math.round(Math.random()) ? 1 : -1))]
                this.acceleration = [0, 0]
                this.colour = green
                this.health = health
                this.max_vel = 2
                this.max_force = 0.5
                this.size = 5
                this.age = 1
                }
            if(dna != False){
                this.dna = []
                for i in range(len(dna)):
                    if (Math.random() < mutation_rate){
                         if (i < 2){
                            this.dna.append(dna[i] + random.uniform(-steering_weights, steering_weights))
                        }else{
                            this.dna.append(dna[i] + random.uniform(-perception_radius_mutation_range, perception_radius_mutation_range))
                        }
                    }else{
                        this.dna.append(dna[i])
                    }
            }else{
                this.dna = [((Math.random() * initial_max_force) * (Math.round(Math.random()) ? 1 : -1)), ((Math.random() * initial_max_force) * (Math.round(Math.random()) ? 1 : -1)), Math.random()*initial_perception_radius, Math.random()*initial_perception_radius]
            }

            update(){
                this.velocity += this.acceleration
 
                this.velocity = normalize(this.velocity)*this.max_vel
    
                this.position += this.velocity
                this.acceleration *= 0
                this.health -= 0.2
                this.colour = lerp()
                this.health = Math.min(health, this.health)
                if this.age % 1000 == 0:
                    console.log(this.age, this.dna)
                this.age += 1

            }
            
            reproduce(){
                if (Math.random() < reproduction_rate){
                    bots.append(create_bot(this.position[0], this.position[1], this.dna))
                }
                    
            }
            
            dead(){
                if(this.health > 0){
                    return(False)
                }else{
                    if(this.position[0] < game_width - boundary_size & this.position[0] > boundary_size & this.position[1] < game_height - boundary_size & this.position[1] > boundary_size){
                        food.append(this.position)
                        return(True)
                    }
                    
                }
            }
            
            apply_force(force){
                this.acceleration += force
            }
            
            seek(target){
                desired_vel = numpy.add(target, -this.position)
                desired_vel = normalize(desired_vel)*this.max_vel
                steering_force = numpy.add(desired_vel, -this.velocity) //REVISAR ESTE ADD QUE HACE
                steering_force = normalize(steering_force)*this.max_force
                return(steering_force)
            }

            eat(list_of_stuff, index){
                closest = None //REVISAR ESTE NONE
                closest_distance = Math.max(game_width, game_height)
                bot_x = this.position[0]
                bot_y = this.position[1]
                item_number = len(list_of_stuff)-1
                for( i in list_of_stuff[::-1]){ // REVISAR ESTE FOR
                    item_x = i[0]
                    item_y = i[1]
                    distance = math.hypot(bot_x-item_x, bot_y-item_y) // REVISAR ESTE MATH HYPOT
                    if(distance < 5){
                        list_of_stuff.pop(item_number)
                        this.health += nutrition[index]
                    }
                    if(distance < closest_distance){
                        closest_distance = distance
                        closest = i
                    } 
                    item_number -=1
                }
                if (closest_distance < this.dna[2 + index]){
                    seek = this.seek(closest) # index)
                    seek *= this.dna[index]
                    seek = normalize(seek)*this.max_force
                    this.apply_force(seek)
                }
            }
            boundaries(){
                desired = None //REVISAR ESTE NONE
                x_pos = this.position[0]
                y_pos = this.position[1]
                if(x_pos < boundary_size){
                    desired = [this.max_vel, this.velocity[1]]
                }else 
                if(x_pos > game_width - boundary_size){
                    desired = [-this.max_vel, this.velocity[1]]
                }
                if(y_pos < boundary_size){
                    desired = [this.velocity[0], this.max_vel]
                }else 
                if(y_pos > game_height - boundary_size){
                     desired = [this.velocity[0], -this.max_vel]
                }
                // REVISAR ESTA CONDICION
                if (desired != None){
                    steer = desired-this.velocity
                    steer = normalize(steer)*this.max_force
                    this.apply_force(steer)
                }
            }

            draw_bot(){
                // PASAR A LO QUE SEA EN JS jaja
                //pygame.gfxdraw.aacircle(gameDisplay, int(self.position[0]), int(self.position[1]), 10, self.colour)
                //pygame.gfxdraw.filled_circle(gameDisplay, int(self.position[0]), int(self.position[1]), 10, self.colour)
                //pygame.draw.circle(gameDisplay, green, (int(self.position[0]), int(self.position[1])), abs(int(self.dna[2])), abs(int(min(2, self.dna[2]))))
                //pygame.draw.circle(gameDisplay, red, (int(self.position[0]), int(self.position[1])), abs(int(self.dna[3])), abs(int(min(2, self.dna[3]))))
                //pygame.draw.line(gameDisplay, green, (int(self.position[0]), int(self.position[1])), (int(self.position[0] + (self.velocity[0]*self.dna[0]*25)), int(self.position[1] + (self.velocity[1]*self.dna[0]*25))), 3)
                //pygame.draw.line(gameDisplay, red, (int(self.position[0]), int(self.position[1])), (int(self.position[0] + (self.velocity[0]*self.dna[1]*25)), int(self.position[1] + (self.velocity[1]*self.dna[1]*25))), 2)
            }

            for (i=0; i<= 10; i++){
                bots.append(create_bot(Math.random()*game_width,Math.random()*game_height))
            }
            running = True

            while(running){
                //gameDisplay.fill(black)
                if(bots.length()<1 || Math.random() < 0.0001){
                    bots.append(create_bot(random.uniform(0,game_width),random.uniform(0,game_height)))
                }
                    
                if(Math.random()<0.1){
                    
                    food.append([(Math.random() * game_width-boundary_size) + boundary_size, (Math.random() * game_height-boundary_size) + boundary_size])
                }
                    
                if(Math.random()<0.01){
                    poison.append([(Math.random() * game_width-boundary_size) + boundary_size,(Math.random() * game_height-boundary_size) + boundary_size])
                }
                    
                if(len(poison)>max_poison){
                    poison.pop(0)
                }
                    
        
                /*for event in pygame.event.get():
                    if event.type == pygame.QUIT:
                        running = False
                    #print(event)
                */
        
                //print(bots[0].position)
                //print((bots[0].position),(bots[0].position+(-size,0)),(bots[0].position+(-size/2,size)))
                for(bot in bots[::-1]){
                    bot.eat(food, 0)
                    bot.eat(poison, 1)
                    bot.boundaries()
                    //bot.seek(pygame.mouse.get_pos())
                    bot.update()
                    if(bot.age > oldest_ever){
                        oldest_ever = bot.age
                        oldest_ever_dna = bot.dna
                        console.log(oldest_ever, oldest_ever_dna)
                    }
                    bot.draw_bot()
                    //pygame.draw.polygon(gameDisplay, bot.colour, ((bot.position),tuple(map(operator.add,bot.position,(-size,0))),tuple(map(operator.add,bot.position,(-size/2,size)))))
                    if(bot.dead()){
                        bots.remove(bot)
                    }else{
                        bot.reproduce()
                    }
                        
                //if Math.random()<0.02:
                    //bots.append(create_bot(random.uniform(0,game_width),random.uniform(0,game_height)))
                // REVISASR EL ELEMENTO DE ESTE FOR
                for(i=0;i<=food.length();i++){
                    pygame.draw.circle(gameDisplay, (0,255,0), (int(i[0]), int(i[1])), 3)
                }
                for(i=0;i<=poison.length();i++){
                    pygame.draw.circle(gameDisplay, (255,0,0), (int(i[0]), int(i[1])), 3)
                }
                //pygame.display.update()
                //clock.tick(fps)
                }
                    
                
            }
        }
            
        


       

        window.requestAnimationFrame(gameLoop);
    </script>
</body>
</html>